<script type="text/javascript">
    RED.nodes.registerType("tuya-smart", {
        category: "input",
        defaults: {
            deviceName: { value: "", required: true },
            deviceIp: { value: "", required: true },
            deviceId: { value: "", required: true },
            deviceKey: { value: "", required: true },
            request: { 
                value: '{"schema": true}', 
                required: false, 
                validate: function(req) { 
                    try {
                        var parsed = JSON.parse(req);
                        var valid = true;
                        if("dps" in parsed) {
                            valid = RED.validators.number()(parsed.dps);
                        }
                        return true;
                    } catch {
                        return false;
                    }
                } 
            },
            pollingInterval: { value: 10, validate:RED.validators.number(), required: true }
            protocolVersion: { value: "3.1", required: true },
        },
        inputs: 1,
        outputs: 1,
        icon: "bridge.png",
        label: function() {
            return this.deviceName || this.deviceIp || "tuya-smart";
        }
    });
</script>

<script type="text/x-red" data-template-name="tuya-smart">
    <div class="form-row">
        <label for="node-input-deviceName"><i class="icon-tag"></i> Device name</label>
        <input type="text" id="node-input-deviceName" placeholder="Your name for the device">
    </div>
    <div class="form-row">
        <label for="node-input-deviceIp"><i class="fa fa-server"></i> Device IP</label>
        <input type="text" id="node-input-deviceIp" placeholder="192.168.3.56">
    </div>
    <div class="form-row">
        <label for="node-input-deviceId"><i class="fa fa-id-badge"></i> Device ID</label>
        <input type="text" id="node-input-deviceId" placeholder="05200678ecfabc93ed86">
    </div>
    <div class="form-row">
        <label for="node-input-deviceKey"><i class="fa fa-key"></i> Device Key</label>
        <input type="text" id="node-input-deviceKey" placeholder="fd358171e8au7ef2">
    </div>
    <div class="form-row">
        <label for="node-input-request"><i class="fa fa-list-ul"></i> Request</label>
        <input type="text" id="node-input-request" placeholder="">
    </div>
    <div class="form-row">
        <label for="node-input-pollingInterval"><i class="fa fa-clock-o"></i> Polling interval (seconds)</label>
        <input type="text" id="node-input-pollingInterval" placeholder="10">
    </div>
    <div class="form-row">
        <label for="node-input-protocolVersion"><i class="fa fa-list-ul"></i> Request</label>
        <input type="text" id="node-input-protocolVersion" placeholder="">
    </div>
</script>

<script type="text/x-red" data-help-name="tuya-smart">
    <h1>tuya-smart</h1>
    <p>Polls the state of tuya smart power plugs periodically. The node reads (polls) the on/off state of a smart device. It will emit messages in the format of </p>
    <p>The output payload will contain the following fields
        <ul>
            <li><code>data: mixed</code> - Depending on the request type. See below.</li>
            <li><code>deviceIp: "string"</code> - The configured device ip</li>
            <li><code>deviceId: "string"</code> - The configured device id (similar to the one from the tuya smart/smart life app</li>
            <li><code>deviceName: "string"</code> - The configured device name (arbitrary) for you to identify devices more easily.</li>
            <li><code>protocolVersion: "string"</code> - The configured protocol version.</li>
        </ul>
    </p>
    <p>The <code>data</code> payload depends on the <code>request</code>. Options are
        <ul>
            <li><code>empty</code> - Just get the device status. Data will be Boolean (true, if the power plug socket is enabled).<li>
            <li><code>{"schema": true}</code> - Get all data for the device. Data will be an object.<li>
            <li><code>{"dps": <number>}</code> - Get a single property from the device. Data will be whatever type that property is.</li>
        </ul>
    <p>
    <p>The input payload respects the following fields
        <ul>
            <li><code>set: any</code> data type depends on the device type. For example boolean to turn power plugs on/off (true will enable the socket, false will disable it)</li>
            <li><code>dpsIndex: any</code> (optional, default: 1) The data position to be set
        </ul>
        Once the state was set successfully, the node will poll the state immediately and provide it through the output.
        Refer to <a href="https://github.com/codetheweb/tuyapi" target="_blank">The tuyapi documentation for details</a>,
    </p>
    <p>Refer to <a href="https://github.com/hgross/node-red-contrib-tuya-smart" target="_blank">the repository</a> for some images of example flows with actual in/out payloads.</p>
</script>
